# =============================================================================
# RECIPEZ DOCKER COMPOSE CONFIGURATION
# =============================================================================
# Multi-container orchestration for Recipez application with PostgreSQL database.
#
# Usage:
#   With bundled database:     docker-compose up -d
#   With external database:    docker-compose --profile external-db up -d
#   View logs:                 docker-compose logs -f
#   Stop:                      docker-compose down
#
# First-time setup:
#   1. cp .env.docker.example .env.docker
#   2. Edit .env.docker with your configuration
#   3. docker-compose up -d

services:
  # ===========================================================================
  # RECIPEZ APPLICATION (with bundled database)
  # ===========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: recipez-app
    restart: unless-stopped

    # Use host network to access services on host (e.g., Open WebUI at 127.0.0.1:8080)
    network_mode: host

    # Environment configuration
    env_file:
      - .env.docker

    environment:
      # Flask configuration
      - FLASK_ENV=${FLASK_ENV:-production}

      # Database components (use localhost since we're on host network)
      - DB_HOST=${DB_HOST:-localhost}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-recipez}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-recipez}
      - DB_SCHEMA=${DB_SCHEMA:-recipez}

      # Construct DATABASE_URL from components
      # Format: postgresql+psycopg://USER:PASSWORD@HOST:PORT/DATABASE?options=-c%20search_path=SCHEMA
      - DATABASE_URL=postgresql+psycopg://${DB_USER:-recipez}:${DB_PASSWORD}@${DB_HOST:-localhost}:${DB_PORT:-5432}/${DB_NAME:-recipez}?options=-c%20search_path=${DB_SCHEMA:-recipez}

      # Initialization flag
      - INIT_DB=${INIT_DB:-false}

      # Database wait timeout
      - DB_WAIT_TIMEOUT=${DB_WAIT_TIMEOUT:-30}

    # Note: ports mapping not needed with network_mode: host
    # App binds directly to host port 5000

    volumes:
      # Bind mounts for persistence (set RECIPEZ_DATA_DIR in .env.docker or defaults to ~/.recipez)
      - ${RECIPEZ_DATA_DIR:-~/.recipez}/uploads:/app/recipez/static/uploads
      - ${RECIPEZ_DATA_DIR:-~/.recipez}/certs:/app/recipez/certs

    depends_on:
      postgres:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Note: networks not used with network_mode: host

    profiles:
      - default

  # ===========================================================================
  # POSTGRESQL DATABASE (bundled)
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: recipez-postgres
    restart: unless-stopped

    # Use host network so app (also on host network) can reach via localhost
    network_mode: host

    environment:
      - POSTGRES_USER=${DB_USER:-recipez}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME:-recipez}
      - DB_SCHEMA=${DB_SCHEMA:-recipez}

    volumes:
      # Bind mount for persistence (set RECIPEZ_DATA_DIR in .env.docker or defaults to ~/.recipez)
      - ${RECIPEZ_DATA_DIR:-~/.recipez}/pgdata:/var/lib/postgresql/data

      # Initialization script (creates schema on first run)
      - ./init-db.sh:/docker-entrypoint-initdb.d/01-init-schema.sh:ro

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-recipez} -d ${DB_NAME:-recipez}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Shared memory for PostgreSQL performance
    shm_size: 128mb

    profiles:
      - default

  # ===========================================================================
  # RECIPEZ APPLICATION (for external database)
  # ===========================================================================
  app-external:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: recipez-app
    restart: unless-stopped

    # Use host network to access services on host (e.g., Open WebUI at 127.0.0.1:8080)
    network_mode: host

    env_file:
      - .env.docker

    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - DATABASE_URL=${DATABASE_URL}
      - INIT_DB=${INIT_DB:-false}
      - DB_WAIT_TIMEOUT=${DB_WAIT_TIMEOUT:-30}

    # Note: ports mapping not needed with network_mode: host
    # App binds directly to host port 5000

    volumes:
      # Bind mounts for persistence (set RECIPEZ_DATA_DIR in .env.docker or defaults to ~/.recipez)
      - ${RECIPEZ_DATA_DIR:-~/.recipez}/uploads:/app/recipez/static/uploads
      - ${RECIPEZ_DATA_DIR:-~/.recipez}/certs:/app/recipez/certs

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Note: networks not used with network_mode: host

    profiles:
      - external-db

# =============================================================================
# NOTES
# =============================================================================
# This configuration uses bind mounts for data persistence.
# Set RECIPEZ_DATA_DIR in .env.docker (defaults to ~/.recipez).
#
# Before starting, create directories with proper permissions:
#
#   export DATA_DIR="${RECIPEZ_DATA_DIR:-$HOME/.recipez}"
#   mkdir -p "$DATA_DIR"/{uploads,certs,pgdata}
#   chmod 777 "$DATA_DIR/uploads" "$DATA_DIR/certs"
#   sudo chown 70:70 "$DATA_DIR/pgdata"
#
# Both app and postgres use host networking for simplified connectivity.
