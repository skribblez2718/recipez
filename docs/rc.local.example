#!/bin/bash
# =============================================================================
# RECIPEZ AUTO-START SCRIPT FOR QUBES OS APPVM
# =============================================================================
# Place this file at: /rw/config/rc.local
# Make executable: chmod +x /rw/config/rc.local
#
# This script runs on every AppVM boot and:
# 1. Configures Docker data directory for persistence
# 2. Pulls latest code from git repository
# 3. Builds and starts Docker containers with host networking
# 4. Sets up qvm-connect-tcp for cross-Qube AI service access
#
# Prerequisites:
# - Docker installed in TemplateVM (see README.md for package list)
# - .env.docker file configured in /home/user/recipez/
# =============================================================================

# =============================================================================
# DOCKER CONFIGURATION
# =============================================================================
# Configure Docker to use persistent storage for images/containers
echo '{"data-root": "/home/user/containers/docker-data"}' > /etc/docker/daemon.json

# Remove old image to force rebuild
docker image rm recipez:latest

# =============================================================================
# RECIPEZ SETUP
# =============================================================================
RECIPEZ_DIR="/home/user/recipez"
RECIPEZ_USER="user"

# 1. Pull latest changes as user
su - $RECIPEZ_USER -c "cd $RECIPEZ_DIR && git pull"

# 2. Source environment variables
set -a
source "$RECIPEZ_DIR/.env.docker"
set +a

# 3. Create Docker network (if not exists)
docker network create recipez-network 2>/dev/null || true

# 4. Build the app image
docker build --no-cache --target production -t recipez:latest "$RECIPEZ_DIR"

# 5. Stop existing containers (if any)
docker stop recipez-postgres recipez-app 2>/dev/null || true
docker rm recipez-postgres recipez-app 2>/dev/null || true

# 6. Start PostgreSQL container (uses host network for app connectivity)
docker run -d \
  --name recipez-postgres \
  --network host \
  --restart unless-stopped \
  --shm-size=128mb \
  -e POSTGRES_USER=${DB_USER:-recipez} \
  -e POSTGRES_PASSWORD=${DB_PASSWORD} \
  -e POSTGRES_DB=${DB_NAME:-recipez} \
  -v /home/user/.recipez/pgdata:/var/lib/postgresql/data \
  -v "$RECIPEZ_DIR/init-db.sh:/docker-entrypoint-initdb.d/01-init-schema.sh:ro" \
  postgres:16-alpine

# 7. Wait for PostgreSQL to be healthy
echo "Waiting for PostgreSQL..."
until docker exec recipez-postgres pg_isready -U ${DB_USER:-recipez} -d ${DB_NAME:-recipez}; do
  sleep 2
done
echo "PostgreSQL is ready"

# 8. Start Recipez app container (uses host network for AI access at 127.0.0.1:8080)
docker run -d \
  --name recipez-app \
  --network host \
  --restart unless-stopped \
  -e FLASK_ENV=${FLASK_ENV:-production} \
  -e DB_HOST=localhost \
  -e DB_PORT=${DB_PORT:-5432} \
  -e DB_USER=${DB_USER:-recipez} \
  -e DB_PASSWORD=${DB_PASSWORD} \
  -e DB_NAME=${DB_NAME:-recipez} \
  -e DB_SCHEMA=${DB_SCHEMA:-recipez} \
  -e "SECRET_KEY=${SECRET_KEY}" \
  -e DOMAIN=${DOMAIN:-recipez.local} \
  -e WEB_PORT=${WEB_PORT:-5000} \
  -e RECIPEZ_JWT_ISSUER=${RECIPEZ_JWT_ISSUER:-} \
  -e RECIPEZ_JWT_AUDIENCE=${RECIPEZ_JWT_AUDIENCE:-} \
  -e "RECIPEZ_ENCRYPTION_KEY=${RECIPEZ_ENCRYPTION_KEY}" \
  -e "RECIPEZ_HMAC_SECRET=${RECIPEZ_HMAC_SECRET}" \
  -e "RECIPEZ_SENDER_PASSWORD=${RECIPEZ_SENDER_PASSWORD:-}" \
  -e "OPENAI_API_KEY=${OPENAI_API_KEY:-}" \
  -e OPENAI_API_BASE=${OPENAI_API_BASE:-http://127.0.0.1:8080/v1} \
  -e OPENAI_RECIPE_MODEL_ID=${OPENAI_RECIPE_MODEL_ID:-gpt-3.5-turbo} \
  -e OPENAI_GROCERY_MODEL_ID=${OPENAI_GROCERY_MODEL_ID:-gpt-3.5-turbo} \
  -e INIT_DB=${INIT_DB:-false} \
  -e DB_WAIT_TIMEOUT=${DB_WAIT_TIMEOUT:-30} \
  -v /home/user/.recipez/uploads:/app/recipez/static/uploads \
  -v /home/user/.recipez/certs:/app/recipez/certs \
  recipez:latest

echo "Recipez started on port ${APP_PORT:-5000}"

# =============================================================================
# CROSS-QUBE AI SERVICE ACCESS
# =============================================================================
# Forward port 8080 from another AppVM running an AI service (e.g., Open WebUI, Ollama)
# Replace 'open-webui-appvm' with the name of your AI service AppVM
qvm-connect-tcp 8080:open-webui-appvm:8080
